<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>b1ackie&#39;blog</title>
  
  
  <link href="https://b1ack1e.github.io/atom.xml" rel="self"/>
  
  <link href="https://b1ack1e.github.io/"/>
  <updated>2021-07-08T09:38:17.809Z</updated>
  <id>https://b1ack1e.github.io/</id>
  
  <author>
    <name>b1ackie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>资源释放</title>
    <link href="https://b1ack1e.github.io/2021/07/08/%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE/"/>
    <id>https://b1ack1e.github.io/2021/07/08/%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE/</id>
    <published>2021-07-08T03:52:26.000Z</published>
    <updated>2021-07-08T09:38:17.809Z</updated>
    
    <content type="html"><![CDATA[<h2 id="资源释放"><a href="#资源释放" class="headerlink" title="资源释放"></a>资源释放</h2><p>将一些文件作为资源加载的程序中，在程序运行的时候再将它们释放到本地上。这样恶意代码会更加隐蔽。</p><h4 id="函数介绍"><a href="#函数介绍" class="headerlink" title="函数介绍"></a>函数介绍</h4><h5 id="FindResource函数，确定具有指定类型和名称的资源在指定模块中的位置"><a href="#FindResource函数，确定具有指定类型和名称的资源在指定模块中的位置" class="headerlink" title="FindResource函数，确定具有指定类型和名称的资源在指定模块中的位置"></a>FindResource函数，确定具有指定类型和名称的资源在指定模块中的位置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HRSRC FindResourceW(</span><br><span class="line">  HMODULE hModule,</span><br><span class="line">  LPCWSTR lpName,</span><br><span class="line">  LPCWSTR lpType</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>hModule：处理包含资源的可执行文件模块。若hModule为NULL，则系统从当前进程的模块中装载资源。</p><p>lpName：指定资源名称</p><p>lpType：指定资源类型</p><p>返回值：如果函数运行成功，那么返回值为指定资源信息块的句柄。可将这个句柄传递给其它函数获取其他信息。如果失败，则返回NULL；</p><h5 id="SizeofResource函数：获取指定资源的字节数"><a href="#SizeofResource函数：获取指定资源的字节数" class="headerlink" title="SizeofResource函数：获取指定资源的字节数"></a>SizeofResource函数：获取指定资源的字节数</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DWORD SizeofResource(</span><br><span class="line">  HMODULE hModule,</span><br><span class="line">  HRSRC   hResInfo</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>hModule：包含资源的可执行文件模块的句柄。若hModule为NULL，则系统从当前进程的模块中装载资源。</p><p>hResInfo：资源局部。此句柄必须由函数FindResource或FindResourceEx来出创建。</p><p>返回值：如果函数运行成功，则返回值为资源的字节数；如果函数运行失败，则返回值为0；</p><h5 id="LoadResource函数：装载指定资源到全局存储器"><a href="#LoadResource函数：装载指定资源到全局存储器" class="headerlink" title="LoadResource函数：装载指定资源到全局存储器"></a>LoadResource函数：装载指定资源到全局存储器</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HGLOBAL LoadResource(</span><br><span class="line">  HMODULE hModule,</span><br><span class="line">  HRSRC   hResInfo</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>hModule：包含资源的可执行文件模块的句柄。若hModule为NULL，则系统从当前进程的模块中装载资源。</p><p>hResInfo：资源局部。此句柄必须由函数FindResource或FindResourceEx来出创建。</p><p>返回值：如果函数运行成功，则返回值为相关资源数据的句柄。如果函数运行失败，则返回值为NULL。</p><h5 id="LockResource函数：锁定资源并得到资源在内存中的第一个字节的指针"><a href="#LockResource函数：锁定资源并得到资源在内存中的第一个字节的指针" class="headerlink" title="LockResource函数：锁定资源并得到资源在内存中的第一个字节的指针"></a>LockResource函数：锁定资源并得到资源在内存中的第一个字节的指针</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LPVOID LockResource(</span><br><span class="line">  HGLOBAL hResData</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>hResData：装载资源的句柄。函数LoadResource可以返回这个句柄。</p><p>返回值：如果装载资源被锁住，则返回值是资源的第一个字节的指针；反之则为NULL。</p><h4 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h4><p>创建一个test.txt文件，写入内容</p><p><img src="/2021/07/08/%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE/1.png"></p><p>在程序中添加一个自定义资源，自定义资源名称为“MYRES”，再将刚才创建的txt文件添加进去</p><p>程序实现源代码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FreeRes.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">//资源控件名称，资源名称，释放后的名称</span></span><br><span class="line"><span class="function">BOOL <span class="title">FreeRes</span><span class="params">(UINT uiResourceName,TCHAR* lpszResType,<span class="keyword">char</span>* lpszSaveFileName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取指定模块的资源</span></span><br><span class="line">    HRSRC hRes = <span class="built_in">FindResource</span>(<span class="literal">NULL</span>, <span class="built_in">MAKEINTRESOURCE</span>(uiResourceName), lpszResType);</span><br><span class="line">    <span class="keyword">if</span> (hRes == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;获取资源失败&quot;</span>, <span class="string">L&quot;&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取大小</span></span><br><span class="line">    DWORD dwSize = <span class="built_in">SizeofResource</span>(<span class="literal">NULL</span>, hRes);</span><br><span class="line">    <span class="keyword">if</span> (dwSize == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;获取字节数失败&quot;</span>, <span class="string">L&quot;&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//装载资源</span></span><br><span class="line">    HGLOBAL hGlobal = <span class="built_in">LoadResource</span>(<span class="literal">NULL</span>, hRes);</span><br><span class="line">    <span class="keyword">if</span> (hGlobal == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;装载资源失败&quot;</span>, <span class="string">L&quot;&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//锁定资源</span></span><br><span class="line">    LPVOID lPvoid = <span class="built_in">LockResource</span>(hGlobal);</span><br><span class="line">    <span class="keyword">if</span>(lPvoid == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;锁定资源失败&quot;</span>, <span class="string">L&quot;&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开始释放资源</span></span><br><span class="line">    FILE* fp;</span><br><span class="line">    <span class="built_in">fopen_s</span>(&amp;fp, lpszSaveFileName, <span class="string">&quot;wb+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;写入资源失败&quot;</span>, <span class="string">L&quot;&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fwrite</span>(lPvoid, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">char</span>), dwSize, fp);</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;按下回车键开始释放资源资源\n&quot;</span>);</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">    BOOL FLAG=<span class="built_in">FreeRes</span>(IDR_MYRES2,<span class="built_in">TEXT</span>(<span class="string">&quot;MYRES&quot;</span>),<span class="string">&quot;free.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (FLAG == TRUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;释放成功\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;释放失败\n&quot;</span>);</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/07/08/%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE/2.png"></p><p>查看free.txt内容</p><p><img src="/2021/07/08/%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE/3.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;资源释放&quot;&gt;&lt;a href=&quot;#资源释放&quot; class=&quot;headerlink&quot; title=&quot;资源释放&quot;&gt;&lt;/a&gt;资源释放&lt;/h2&gt;&lt;p&gt;将一些文件作为资源加载的程序中，在程序运行的时候再将它们释放到本地上。这样恶意代码会更加隐蔽。&lt;/p&gt;
&lt;h4 id=&quot;函数</summary>
      
    
    
    
    <category term="学习记录" scheme="https://b1ack1e.github.io/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="恶意代码" scheme="https://b1ack1e.github.io/tags/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81/"/>
    
    <category term="黑客编程" scheme="https://b1ack1e.github.io/tags/%E9%BB%91%E5%AE%A2%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>写在前面的话</title>
    <link href="https://b1ack1e.github.io/2021/07/08/%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%E8%AF%9D/"/>
    <id>https://b1ack1e.github.io/2021/07/08/%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%E8%AF%9D/</id>
    <published>2021-07-08T03:50:10.000Z</published>
    <updated>2021-07-08T09:40:20.968Z</updated>
    
    <content type="html"><![CDATA[<p>一直都在说要写博客，但是一直都没有很好的坚持下来，上次写博客还是大二的时候，这都过去好久了。</p><p>现在自己也搭建了一个博客，希望能够好好坚持下去吧，作为日常的学习记录，也希望能够写出一些有价值的东西。</p><p>最后的最后，我是不知名小团队satter的b1ackie。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;一直都在说要写博客，但是一直都没有很好的坚持下来，上次写博客还是大二的时候，这都过去好久了。&lt;/p&gt;
&lt;p&gt;现在自己也搭建了一个博客，希望能够好好坚持下去吧，作为日常的学习记录，也希望能够写出一些有价值的东西。&lt;/p&gt;
&lt;p&gt;最后的最后，我是不知名小团队satter的b1a</summary>
      
    
    
    
    
  </entry>
  
</feed>
